import os
import time
import requests

from ayclient import api, config


def process(target_event_id: str, source_event_id: str):

    # download the file
    url = f"{config.server_url}/addons/{config.addon_name}/{config.addon_version}"
    url += f"/private/{source_event_id}"

    res = requests.get(url, stream=True, headers={"X-Api-Key": config.api_key})
    res.raise_for_status()
    target_path = "/tmp/processor.zip"
    with open(target_path, "wb") as f:
        f.write(res.content)

    print(os.path.getsize(target_path))


def main():
    while True:
        print("I am a service")
        req = {
            "sourceTopic": "openpype_import.upload",
            "targetTopic": "openpype_import.process",
            "sender": config.service_name,
            "description": "OpenPype import: process",
        }
        res = api.post("enroll", json=req)

        if res.status_code == 204:
            print("Nothing to do")
            time.sleep(5)
            continue

        data = res.json()
        process(data["id"], data["dependsOn"])
        break


if __name__ == "__main__":
    main()
